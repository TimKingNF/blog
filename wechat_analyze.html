<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>微信聊天记录的数据分析 - 小花园</title>

	<meta name="author" content="timking" />
	<meta name="copyright" content="timking" />

	<meta property="og:site_name" content="小花园" />


	<meta name="twitter:card" content="summary" />
	<meta name="twitter:title" content="微信聊天记录的数据分析" />
	<meta name="date" content="2018-05-27 16:00:00+08:00" />
	<meta property="og:type" content="article" />
	<meta property="og:locale" content="en" />
	<meta property="og:published_time" content="2018-05-27 16:00:00+08:00" />
	<meta property="og:title" content="微信聊天记录的数据分析" />
	<meta property="og:url" content="https://timkingnf.github.io/blog/wechat_analyze.html" />
	<meta property="og:description" content="简单的展示了一个分析微信聊天记录的流程" />
	<meta name="description" content="简单的展示了一个分析微信聊天记录的流程" />

	<meta name="HandheldFriendly" content="True" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0" />
	<link rel="shortcut icon" href="https://timkingnf.github.io/blog/theme/favicon.ico" type="image/x-icon" />
	<link rel="icon" href="https://timkingnf.github.io/blog/theme/favicon.ico" type="image/x-icon" />
	<link href='https://fonts.googleapis.com/css?family=Droid+Sans:700,400|Droid+Sans+Mono' rel='stylesheet' type='text/css' />
	<link rel="stylesheet" href="https://timkingnf.github.io/blog/theme/css/main.css" type="text/css" />

	<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script src="https://cdn.rawgit.com/leafo/sticky-kit/v1.1.2/jquery.sticky-kit.min.js"></script>
<script src="https://timkingnf.github.io/blog/theme/js/require.js"></script>
<script type="text/javascript">
	requirejs.config({
		baseUrl: "theme",
		paths: {
			"plotly-latest": 'js/plotly-latest.min',
			"embed-amd": "js/embed-amd",
		},
		waitSeconds: 0, // 设置模块等待js加载
	});
	require(
		[

		],
		function(){
			// 固定元素
			$(".toc, .search_warpper").stick_in_parent({
				parent: ".content"
			});
		}
	)
</script>

	<link href="https://timkingnf.github.io/blog/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="小花园 RSS Feed" />

</head>

<body>
	<header class="clearfix" role="banner">
		<!-- <div class="wrapper">
			<h1 class="huge">
				<a href="https://timkingnf.github.io/blog">小花园</a>
			</h1>
		</div> -->
	</header>

<div role="main" class="content clearfix">
	<article>
		<div class="post wrapper">
			<h1>微信聊天记录的数据分析</h1>
			<p>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>某一天突发奇想，想要把聊天记录中和某人的聊天导出来做一轮数据分析。所以就开始了这么一个邪恶的计划 :)</p>
<p>由于前人已经破解了微信的加密规则，在目前加密模式还没变的情况下，只需要参照前人的经验就好了。但是在目前微信数亿用户的情况下，而本地数据库又是存在用户的手机上，微信不太可能对此进行升级，所以密码的加密规则也不太可能改变。如果对反编译的过程有兴趣，可以参照以下文章。</p>
<blockquote><p><a href="http://blog.csdn.net/jiangwei0910410003/article/details/52238891">反编译微信参考</a></p>
</blockquote>
<h2 id="导出微信的数据库文件">导出微信的数据库文件<a class="anchor-link" href="#导出微信的数据库文件">&para;</a></h2><p>已知微信消息的存放地址在 <code>/data/data/com.tencent.mm/MicroMsg/&lt;md5hash&gt;/EnMicroMsg.db</code> 中。</p>
<p>找到之后，可以通过 <code>adb pull /data/data/com.tencent.mm/MicroMsg/&lt;md5hash&gt;/EnMicroMsg.db d:/</code> 命令将数据库文件导出到本地。</p>
<p>这里需要注意的有两点。</p>
<ul>
<li>md5hash的值：md5(mm+uin)，值得注意的是，在第二步没有执行之前是并没有办法知道UIN的值的，这里最简单的就是直接看像md5串的目录名。再通过第二步就可以知道具体的UIN值了。</li>
<li>如果发现目录打不开或者data目录下没有内容。可以通过adb工具添加权限。具体执行如下：  </li>
</ul>
<div class="highlight"><pre><span></span>adb shell
su
chmod <span class="m">777</span> /data
chmod <span class="m">777</span> /data/data
chmod -R <span class="m">777</span> /data/data/com.tencent.mm
</pre></div>
<h2 id="获取解密用的key">获取解密用的key<a class="anchor-link" href="#获取解密用的key">&para;</a></h2><p>已知微信本地数据库的加密规则为 key=md5(IMEI+uin) | cut -c -7，这里详细介绍一下如何获取IMEI和UIN。</p>
<p>获取IMEI:<br/>
有些手机可以直接从系统信息上看到IMEI（比如说MEIZU），如果看不到的，可以通过在拨号盘输入 <code>*#06#</code> 查看获取。</p>
<p>获取UIN:<br/>
UIN在 com.tencent.mm/shared_prefs/system_config_prefs.xml 中，找到 default_uin 条目，该值由于int32的溢出，可能为负数。</p>
<h2 id="解密微信的数据库文件">解密微信的数据库文件<a class="anchor-link" href="#解密微信的数据库文件">&para;</a></h2><p>对数据库进行解密。下载并安装sqlcipher。</p>
<p>Mac下可以通过 <code>brew install sqlcipher</code> 进行安装。<br/>
注意下载的版本为3.x，但是目前微信使用的是2.x的加密方式，而3.x默认不向下兼容，需要手动指定。</p>
<p>执行以下命令进行解密数据库。然后在同级目录下会出现decrypted_database.db文件。<br/>
至此解密数据库完成，可以通过sqlite3数据库进行读取数据。</p>
<div class="highlight"><pre><span></span>sqlcipher EnMicroMsg.db
PRAGMA <span class="nv">key</span> <span class="o">=</span> <span class="s2">"&lt;第二步拿到的key&gt;"</span><span class="p">;</span>
PRAGMA cipher_migrate<span class="p">;</span>
ATTACH DATABASE <span class="s2">"decrypted_database.db"</span> AS decrypted_database KEY <span class="s2">""</span><span class="p">;</span>
SELECT sqlcipher_export<span class="o">(</span><span class="s2">"decrypted_database"</span><span class="o">)</span><span class="p">;</span>
DETACH DATABASE decrypted_database<span class="p">;</span>
</pre></div>
<h2 id="获取和聊天对象的聊天记录">获取和聊天对象的聊天记录<a class="anchor-link" href="#获取和聊天对象的聊天记录">&para;</a></h2><p>上一步获取到解密的数据库之后，就可以使用 <code>sqllite</code> 工具读取数据库文件了。</p>
<p>可以通过以下sql语句查询出与某人的聊天记录。查询出具体的数据之后导成csv。</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">datetime</span><span class="p">(</span><span class="n">subStr</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">createTime</span> <span class="k">as</span> <span class="nb">text</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="s1">'unixepoch'</span><span class="p">,</span> <span class="s1">'localtime'</span><span class="p">)</span> <span class="k">as</span> <span class="n">theTime</span><span class="p">,</span><span class="k">case</span> <span class="n">m</span><span class="p">.</span><span class="n">isSend</span> <span class="k">when</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">r</span><span class="p">.</span><span class="n">nickname</span> <span class="k">when</span> <span class="mi">1</span> <span class="k">then</span> <span class="s1">'我'</span><span class="k">end</span> <span class="k">as</span> <span class="n">person</span><span class="p">,</span><span class="n">m</span><span class="p">.</span><span class="n">content</span> <span class="k">from</span> <span class="n">message</span> <span class="n">m</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">rcontact</span> <span class="n">r</span> <span class="k">on</span> <span class="n">m</span><span class="p">.</span><span class="n">talker</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">username</span> <span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="k">type</span><span class="o">=</span><span class="mi">1</span> <span class="k">and</span> <span class="n">r</span><span class="p">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="s1">'&lt;微信昵称&gt;'</span>
</pre></div>
<h2 id="对聊天记录进行处理">对聊天记录进行处理<a class="anchor-link" href="#对聊天记录进行处理">&para;</a></h2><p>到了这一步总算进入正题了，通过上面拿到了我们想要的聊天记录。<br/>
现在就可以进行我们想要做的分析啦。 :)</p>
<p>粗略的看了一下导出的csv文件。<br/>
csv文件是以发言时间、发送人、发送文本的格式组成的。由<code>\t</code>分割开。<br/>
同时在聊天对话中会存在很多换行符，所以需要对换行符进行处理。</p>
<p>未完待续。。。</p>
<h2 id="参考文章:">参考文章:<a class="anchor-link" href="#参考文章:">&para;</a></h2><blockquote><p><a href="https://blog.slinuxer.com/2015/10/微信聊天记录">https://blog.slinuxer.com/2015/10/微信聊天记录</a><br/>
<a href="http://blog.csdn.net/njweiyukun/article/details/54024442">http://blog.csdn.net/njweiyukun/article/details/54024442</a></p>
</blockquote>
</div>
</div>
</div>
</p>

			<!-- <a href="https://twitter.com/share" class="twitter-share-button" data-via="" data-lang="en" data-size="large" data-related="">Tweet</a>
			<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script> -->

			<div class="page-nav">
				<a class="btn right" href="https://timkingnf.github.io/blog/jupyter_describe.html">
					Jupyter Notebook Learning ➡
				</a>
			</div>

			<div class="comments">
				<h2>Comments !</h2>
			    <div id="disqus_thread"></div>
			    <script type="text/javascript">
			       var disqus_identifier = "wechat_analyze.html";
			       (function() {
			       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			       dsq.src = 'https://https-timkingnf-github-io-blog.disqus.com/embed.js';
			       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			      })();
				</script>
			</div>
		</div>

<div class="wrapper meta">
	<ul class="nav">
		<li><a href="https://timkingnf.github.io/blog/index.html">Home</a></li>
		<li><a href="https://timkingnf.github.io/blog/archives.html">Archive</a></li>
		<li><a href="https://timkingnf.github.io/blog/tags.html">Tags</a></li>
		<li><a href="https://timkingnf.github.io/blog/categories.html">Categories</a></li>

		<li><a href="https://github.com/TimKingNF">GitHub</a></li>
		<li><a href="mailto:timking.nf@foxmail.com">Email</a></li>
	</ul>

	<div class="search_warpper">
		<h2>Search</h2>
		<form action="https://timkingnf.github.io/blog/search.html">
			<div class="tipue_search_group">
			<input type="text" name="q" class="search_text" pattern=".{3,}" title="At least 3 characters" required>
			</div>
		</form>

		<div id="tipue_search_content"></div>
	</div>
</div>

<div class="meta wrapper">
	<time datetime="2018-05-27T16:00:00+08:00" pubdate>
		2018-05-27
	</time>


	<ul class="tag clearfix">
		<li><a href="https://timkingnf.github.io/blog/category/shi-yi.html">拾遗</a></li>

	</ul>

	<ul class="tag clearfix">
	</ul>

	<nav class="toc">
		<div id="toc"><ul><li><a class="toc-href" href="#导出微信的数据库文件" title="导出微信的数据库文件&para;">导出微信的数据库文件&para;</a></li><li><a class="toc-href" href="#获取解密用的key" title="获取解密用的key&para;">获取解密用的key&para;</a></li><li><a class="toc-href" href="#解密微信的数据库文件" title="解密微信的数据库文件&para;">解密微信的数据库文件&para;</a></li><li><a class="toc-href" href="#获取和聊天对象的聊天记录" title="获取和聊天对象的聊天记录&para;">获取和聊天对象的聊天记录&para;</a></li><li><a class="toc-href" href="#对聊天记录进行处理" title="对聊天记录进行处理&para;">对聊天记录进行处理&para;</a></li><li><a class="toc-href" href="#参考文章:" title="参考文章:&para;">参考文章:&para;</a></li></ul></div>
	</nav>
</div>

	</article>
</div>

	<a href="#" class="scoll-top"></a>

	<!-- <footer class="clearfix">

		<a href="#" class="scoll-top"></a>

	</footer> -->

	<script>
	  var _gaq=[['_setAccount','UA-120924939-1'],['_trackPageview']];
	  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
	  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
	  s.parentNode.insertBefore(g,s)}(document,'script'));
	</script>

</body>
</html>